name: IPTV Auto Renewal

on:
  schedule:
    # Executa a cada 2 dias (48 horas) às 00:00 UTC
    # Formato: minuto hora dia mês dia-da-semana
    - cron: '0 0 */2 * *'
  workflow_dispatch:  # Permite execução manual

jobs:
  renew-credentials:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2
    
    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        playwright install chromium
        playwright install-deps chromium
    
    - name: Create data directory
      run: mkdir -p data
    
    - name: Configure email from secrets
      env:
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        EMAIL_CONFIG: ${{ secrets.EMAIL_CONFIG }}
      run: |
        if [ -z "$EMAIL_CONFIG" ]; then
          echo "⚠️  EMAIL_CONFIG secret not found. Creating from individual secrets..."
          python << 'PYTHON_SCRIPT'
import json
import os
import sys

os.makedirs('data', exist_ok=True)

# Get values from environment variables (safely handles special characters)
smtp_server = os.environ.get('SMTP_SERVER', 'smtp.gmail.com')
smtp_port_str = os.environ.get('SMTP_PORT', '587')
smtp_port = int(smtp_port_str) if smtp_port_str.isdigit() else 587
email = os.environ.get('SENDER_EMAIL', '')
password = os.environ.get('SENDER_PASSWORD', '')
to_email = os.environ.get('RECEIVER_EMAIL', '')

# Validate required fields
if not email or not password or not to_email:
    print("❌ Missing required email secrets: SENDER_EMAIL, SENDER_PASSWORD, RECEIVER_EMAIL")
    sys.exit(1)

# Create config in the format expected by EmailSender
# File: data/email_config.json (not data/config.json)
# Structure: flat (not nested)
# Fields: email, password, to_email (not sender_email, sender_password, receiver_email)
config = {
    'smtp_server': smtp_server,
    'smtp_port': smtp_port,
    'email': email,
    'password': password,
    'to_email': to_email,
    'use_tls': True
}

config_file = 'data/email_config.json'
with open(config_file, 'w', encoding='utf-8') as f:
    json.dump(config, f, indent=4, ensure_ascii=False)

print('✅ Email config created from secrets')
print(f'   File: {config_file}')
print(f'   From: {email}')
print(f'   To: {to_email}')
PYTHON_SCRIPT
        else
          # EMAIL_CONFIG is a JSON string, write it directly
          echo "$EMAIL_CONFIG" > data/email_config.json
          echo "✅ Email config created from EMAIL_CONFIG secret"
        fi
    
    - name: Run IPTV renewal
      env:
        RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
      run: |
        python -m src.send_m3u_email
    
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: error-logs
        path: |
          data/*.log
          *.log
